# Minio

## Install MinIO

1. Install MinIO on your server. You can download it from the official website or use a package manager if available.
    ```bash
    wget https://dl.min.io/server/minio/release/linux-amd64/minio
    chmod +x minio
    sudo mv minio /usr/local/bin
    ```

2. Generate SSL Certificates using Certbot
    While setting up nginx we already automated this autoregeneration of certificates in every3 months 
    The certificates will be stored in /etc/letsencrypt/live/arpansahu.me/.
    
3. Configure MinIO with SSL Certificates:
    Configure MinIO to use the SSL certificates generated by Certbot. Create a directory to store the certificates and copy them from the Certbot directory.

    ```bash
    sudo mkdir -p /etc/minio/certs
    sudo cp /etc/letsencrypt/live/yourdomain.com/fullchain.pem /etc/minio/certs/public.crt
    sudo cp /etc/letsencrypt/live/yourdomain.com/privkey.pem /etc/minio/certs/private.key
    ```

4. Environment File Configuration
    Ensure your environment file, usually located at /etc/default/minio, has the following content: if file is not present create it
    ```bash
    MINIO_VOLUMES="/mnt/minio"

    # Define where to find the TLS certificates
    MINIO_OPTS="--certs-dir /etc/minio/certs --console-address :9001"

    # Define the admin user (min 3 characters)
    MINIO_ROOT_USER=user_edit_this

    # Define the default admin user password (min 8 characters)
    MINIO_ROOT_PASSWORD=password_edit_this
    ```

5. Setup Directory and Permissions

    ```bash
    sudo mkdir -p /mnt/minio
    sudo chown -R minio-user:minio-user /mnt/minio
    
    sudo mkdir -p /etc/minio/certs
    sudo chown -R minio-user:minio-user /etc/minio/certs
    
    sudo chown minio-user:minio-user /etc/minio/certs/public.crt
    sudo chown minio-user:minio-user /etc/minio/certs/private.key
    ```

6. Reload Systemd and Start MinIO
    Reload the systemd daemon and start the MinIO service
    
    ```echo
    sudo systemctl daemon-reload
    sudo systemctl start minio
    ```
Note: minio api and ui server both run at 0.0.0.0 host by default


## Nginx Setup as Reverse Proxy

Note: Nginx is already setup in the other steps as seen before right now i will discuss about server configuration for minio and minioui

1. Nginx Server configuration for minio api server 
    ```bash
    server {
        listen         80;
        server_name    minio.arpansahu.me;

        # Redirect HTTP to HTTPS
        if ($scheme = http) {
            return 301 https://$server_name$request_uri;
        }
    }

    server {
        listen         443 ssl;
        server_name    minio.arpansahu.me;

        # SSL certificates
        ssl_certificate /etc/minio/certs/public.crt;
        ssl_certificate_key /etc/minio/certs/private.key;

        # Allow special characters in headers
        ignore_invalid_headers off;

        # Allow any size file to be uploaded.
        # Set to a value such as 1000m; to restrict file size to a specific value
        client_max_body_size 0;

        # Disable buffering
        proxy_buffering off;
        proxy_request_buffering off;

        location / {
            proxy_pass          https://0.0.0.0:9000;
            proxy_set_header    Host $host;
            proxy_set_header    X-Real-IP $remote_addr;
            proxy_set_header    X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header    X-Forwarded-Proto $scheme;

            # Set maximum allowed body size for uploads
            client_max_body_size 0; # Adjust the value as needed

            proxy_connect_timeout 300;
            # Default is HTTP/1, keepalive is only enabled in HTTP/1.1
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            chunked_transfer_encoding off;
        }
    }
    ```

2. Nginx Server configuration for minio ui server 
    ```bash
    server {
        listen         80;
        server_name    minioui.arpansahu.me;
        # force https-redirects
        if ($scheme = http) {
            return 301 https://$server_name$request_uri;
            }
    
        location / {
             proxy_pass               https://0.0.0.0:9001;
             proxy_set_header        Host $host;
             proxy_set_header    X-Forwarded-Proto $scheme;
    
             # WebSocket support
             proxy_http_version 1.1;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Connection "upgrade";
        }
    
        listen 443 ssl; # managed by Certbot
        ssl_certificate /etc/letsencrypt/live/arpansahu.me/fullchain.pem; # managed by Certbot
        ssl_certificate_key /etc/letsencrypt/live/arpansahu.me/privkey.pem; # managed by Certbot
        include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
        ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot
    }
    ```
### Setup Copy Cron to copy whenever cerbot updates the certificate to /etc/minio/certs

1. Create a Cron Shell file 
    ```bash
    sudo vi /usr/local/bin/update_minio_certs.sh
    ```

2. Add this script to update_minio_certs.sh
    ```bash
    #!/bin/bash
    # Paths to the Let's Encrypt certificates
    CERT_SRC_DIR="/etc/letsencrypt/live/yourdomain.com"
    CERT_DST_DIR="/etc/minio/certs"

    # Path to the public certificate and private key in the source directory
    SRC_PUBLIC_CERT="${CERT_SRC_DIR}/fullchain.pem"
    SRC_PRIVATE_KEY="${CERT_SRC_DIR}/privkey.pem"

    # Path to the public certificate and private key in the destination directory
    DST_PUBLIC_CERT="${CERT_DST_DIR}/public.crt"
    DST_PRIVATE_KEY="${CERT_DST_DIR}/private.key"

    # Function to send email using Mailjet API
    send_email() {
        local subject=$1
        local body=$2

        python3 <<END
    import os
    from mailjet_rest import Client

    api_key = 'your-mailjet-api-key'
    api_secret = 'your-mailjet-api-secret'
    mailjet = Client(auth=(api_key, api_secret), version='v3.1')

    data = {
    'Messages': [
        {
        "From": {
            "Email": "your-email@example.com",
            "Name": "MinIO Cert Update"
        },
        "To": [
            {
            "Email": "recipient-email@example.com",
            "Name": "Recipient"
            }
        ],
        "Subject": "$subject",
        "TextPart": "$body"
        }
    ]
    }

    result = mailjet.send.create(data=data)
    print(result.status_code)
    print(result.json())
    END
    }

    # Check if the certificates have changed and copy if they have
    if ! cmp -s "$SRC_PUBLIC_CERT" "$DST_PUBLIC_CERT" || ! cmp -s "$SRC_PRIVATE_KEY" "$DST_PRIVATE_KEY"; then
        sudo cp "$SRC_PUBLIC_CERT" "$DST_PUBLIC_CERT"
        sudo cp "$SRC_PRIVATE_KEY" "$DST_PRIVATE_KEY"
        sudo systemctl restart minio
        echo "MinIO certificates updated and service restarted at $(date)" >> /var/log/minio_cert_update.log
        send_email "MinIO Certificates Updated" "MinIO certificates were updated and the service was restarted on $(date)."
    else
        echo "No changes detected in MinIO certificates at $(date)" >> /var/log/minio_cert_update.log
        send_email "No Changes in MinIO Certificates" "No changes were detected in MinIO certificates on $(date)."
    fi
    ```

    Here you need to replace your-mailjet-api-key, your-mailjet-api-secret, your-email@example.com and yourdomain.com

    1. Get Api Credentials from mailJet visit https://www.mailjet.com


3. Changing permissions to execute update_minio_certs.sh
    ```bash
    sudo chmod +x /usr/local/bin/update_minio_certs.sh
    ```
4.  Update Cron Job or Systemd Timer

    ```bash
    sudo crontab -e
    ```

    Add the following line to run the script every day at midnight:

    ```bash
    0 0 * * * /usr/local/bin/update_minio_certs.sh
    ```

